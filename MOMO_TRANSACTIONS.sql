SELECT count(distinct(SUBSTR(DATETIME,12,2))), SUBSTR(DATETIME,1,10)
FROM REPORT_USER.IT_EWP_FINANCIAL_CSV
WHERE DATETIME like'2019-05-04%'
group by SUBSTR(DATETIME,1,10)


------SCRIPTS EVDGN.sp------------------------
select * from IT_EWP_FINANCIAL_CSV
WHERE to_date(substr(DATETIME,9,2)||'/'||substr(DATETIME,6,2)||'/'||substr(DATETIME,1,4),'dd/mm/yyyy') between to_date('01/01/2018','dd/mm/yyyy') AND to_date('31/12/2018','dd/mm/yyyy')--to_char(sysdate-48,'yyyy-mm-dd') and to_char(sysdate-18,'yyyy-mm-dd')
and (FROMUSERNAME = 'EVDGN.sp' OR TOMSISDN = 'EVDGN.sp')

select END_TIME TRANSACTION_DATE,ERSREFERENCE,SENDER_RESELLER_ID SENDERRESELLERID,RECEIVER_MSISDN,RECEIVER_RESELLER_ID RECEIVER_ID,REQUEST_AMOUNT_VALUE/100 SENDERAMOUNT,
RECEIVER_AMOUNT_VALUE/100 RECEIVER_AMOUNT,TRANSACTION_PROFILE TRANSACTION_TYPE_DESC,RECEIVER_BALANCE_VALUE_BEFORE RECEIVERBALANCEVALUEBEFORE,RECEIVER_BALANCE_VALUE_AFTER SENDERBALANCEVALUEAFTER,INITIATOR_USER_ID REMOTEADDRESS
from report_user.IT_MIS_ERS_TDR_DETAIL_CELLIDNW --partition(D20181214_TDR_DETAIL_CELLID_NW)
WHERE to_date(to_char(END_TIME ,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date(to_char(sysdate-36 ,'dd/mm/yyyy'),'dd/mm/yyyy') and to_date(to_char(sysdate-6 ,'dd/mm/yyyy'),'dd/mm/yyyy')
and UPPER(trim(TRANSACTION_PROFILE))='MM2ERS'
and upper(RESULT_STATUS)='SUCCESS'
-- AND UPPER(TRANSACTION_TYPE)='TRANSFER' 
and upper(RECEIVER_AMOUNT_VALUE)<>'\N'
and upper(REQUEST_AMOUNT_VALUE)<>'\N'

------------------------------------------

SELECT a.MSISDN MSISDN_ECW,a.OTHERID OTHERID_ECW,a.OTHERID_TYPE OTHERID_TYPE_ECW,a.ACCOUNT_NAME ACCOUNT_NAME_ECW
FROM (
SELECT MSISDN,OTHERID,OTHERID_TYPE,ACCOUNT_NAME FROM  REPORT_USER.IT_MOMO_ACCOUNT_CREATE_ON_ECW
UNION ALL
SELECT MSISDN,OTHERID,OTHERID_TYPE,ACCOUNT_NAME FROM REPORT_USER.IT_MOMO_ACNT_CREATE_ON_FUNDAMO) a


select  distinct(INITIATINGUSER) 
from REPORT_USER.IT_EWP_FINANCIAL_CSV
WHERE DATETIME like'2019-02-%'
--and to_date(substr(DATETIME,9,2)||'/'||substr(DATETIME,6,2)||'/'||substr(DATETIME,1,4),'dd/mm/yyyy') between to_date('01/01/2016','dd/mm/yyyy') AND to_date('31/12/2018','dd/mm/yyyy')--to_char(sysdate-48,'yyyy-mm-dd') and to_char(sysdate-18,'yyyy-mm-dd')
and (fromUSERNAME LIKE'%airtime%' or TOUSERNAME LIKE'%airtime%')
and TRANSACTIONTYPE='ADJUSTMENT'


select TRANSACTIONTYPE, sum(AMOUNT) AMOUNT, TRANSACTIONSTATUS
from REPORT_USER.IT_EWP_FINANCIAL_CSV
WHERE to_date(substr(DATETIME,9,2)||'/'||substr(DATETIME,6,2)||'/'||substr(DATETIME,1,4),'dd/mm/yyyy') between to_date('01/01/2016','dd/mm/yyyy') AND to_date('31/12/2018','dd/mm/yyyy')--to_char(sysdate-48,'yyyy-mm-dd') and to_char(sysdate-18,'yyyy-mm-dd')
and (fromUSERNAME LIKE'%airtime%' or TOUSERNAME LIKE'%airtime%')
group by TRANSACTIONTYPE, TRANSACTIONSTATUS

-------- le script permettant de générer le rapport commissionning momo---------------------------------------

select to_date(substr(b.DATETIME,1,10),'yyyy-mm-dd') DATETIME,b.FINANCIALTRANSACTIONID,b.TRANSACTIONTYPE ORIGIN_TRANSACTIONTYPE,
       trim(a.INSTR_HEADER_TYPE) INSTR_HEADER_TYPE,a.INSTR_AMOUNT,a.INSTR_TO_COMM_BEFORE,a.INSTR_TO_COMM_AFTER,a.INSTR_TO_FROUSERPROFILE,a.INSTR_TO_FROMSISDN
FROM TBL_FINANCIALLOG@MIS2MOMOREPORT a,EWP_FINANCIAL_CSV@MIS2MOMOREPORT b
where trim(a.INSTR_HEADER_FID)=trim(b.FINANCIALTRANSACTIONID)
-- AND to_date(to_char(a.INSTR_HEADER_TIME,'dd/mm/yyyy'),'dd/mm/yyyy')=to_date(substr(b.DATETIME,1,10),'yyyy-mm-dd')
and upper(trim(a.INSTR_HEADER_TYPE))='COMMISSIONING'
and upper(trim(b.TRANSACTIONTYPE)) in('CASH_OUT','CASH_IN')
and to_date(substr(b.DATETIME,1,10),'yyyy-mm-dd') between to_date('2019-03-01','yyyy-mm-dd') and to_date('2019-04-14','yyyy-mm-dd')
and trim(b.FINANCIALTRANSACTIONID)='25803441'



SELECT TRANSACTIONID,
FINANCIALTRANSACTIONID,
EXTERNALTRANSACTIONID,
DATETIME,
INITIATINGUSER,
REALUSER,
FROMID,
FROMMSISDN,
decode(FROMMSISDN,'224662172493', 'CSC KALOUM',
'224662343503', 'CSC MINIERE',
'224662364036', 'CSC KANKAN',
'224662187028', 'CSC KAMSAR',
'224662173865', 'CSC NZEREKORE',
'224662342115', 'CSC COLEAH',
'224662672067', 'CSC MATOTO',
'224662091025', 'CSC DABOMPA',
'224669535105', 'CSC PRIMA CENTER',
'224660961234', 'CSC SIGUIRI',
'224666901000', 'CSC AEROPORT',
'224666556735', 'CSC LAMBANYI',
'224666212099', 'CSC PLAZZA DIAMOND',
'224662180958', 'CSC MAMOU',
'224660909348', 'CSC LABE',
'224660961229', 'CSC Kindia',
'224662280123', 'Petite Caisse Finance',
'224660579070', 'Petite Caisse HR',
'224660956449', 'MFS',
'224662140783', 'S and D Coordinateur') FROM_CSC,
FROMUSERNAME,
FROMPROFILE,
FROMACCOUNT,
FROMFEE,
FROMLOYALTYREWARD,
FROMLOYALTYFEE,
FROMBANKDOMAIN,
TOID,
TOMSISDN,
decode(TOMSISDN,'224662172493', 'CSC KALOUM',
'224662343503', 'CSC MINIERE',
'224662364036', 'CSC KANKAN',
'224662187028', 'CSC KAMSAR',
'224662173865', 'CSC NZEREKORE',
'224662342115', 'CSC COLEAH',
'224662672067', 'CSC MATOTO',
'224662091025', 'CSC DABOMPA',
'224669535105', 'CSC PRIMA CENTER',
'224660961234', 'CSC SIGUIRI',
'224666901000', 'CSC AEROPORT',
'224666556735', 'CSC LAMBANYI',
'224666212099', 'CSC PLAZZA DIAMOND',
'224662180958', 'CSC MAMOU',
'224660909348', 'CSC LABE',
'224660961229', 'CSC Kindia',
'224662280123', 'Petite Caisse Finance',
'224660579070', 'Petite Caisse HR',
'224660956449', 'MFS',
'224662140783', 'S and D Coordinateur') TO_CSC,
TOUSERNAME,
TOPROFILE,
TOACCOUNT,
TOFEE,
TOLOYALTYREWARD,
TOLOYALTYFEE,
TOBANKDOMAIN,
TRANSACTIONTYPE,
AMOUNT,
CURRENCY,
TRANSACTIONSTATUS
from IT_EWP_FINANCIAL_CSV
WHERE DATETIME like'2019-01-%'
and (FROMMSISDN IN ('224662172493',
'224662343503',
'224662364036',
'224662187028',
'224662173865',
'224662342115',
'224662672067',
'224662091025',
'224669535105',
'224660961234',
'224666901000',
'224666556735',
'224666212099',
'224662180958',
'224660909348',
'224660961229',
'224662280123',
'224660579070',
'224660956449',
'224662140783')
OR TOMSISDN IN ('224662172493',
'224662343503',
'224662364036',
'224662187028',
'224662173865',
'224662342115',
'224662672067',
'224662091025',
'224669535105',
'224660961234',
'224666901000',
'224666556735',
'224666212099',
'224662180958',
'224660909348',
'224660961229',
'224662280123',
'224660579070',
'224660956449',
'224662140783'))


--------------------------BUNDLE PURCHASE VIA MOMO------------------------------------
SELECT * FROM (
select to_date(to_char(UTC_TIMESTAMP,'dd/mm/yyyy'),'dd/mm/yyyy') CRS_REPORT_DATE, sum(replace(TOTAL_COST,',','.')) TOTAL_COST,SERVED_MSISDN CRS_MSISDN,
SERVICE_IDENTIFIER_ID, count(*) CRS_TOTAL
from (select * from report_user.IT_MIS_USAGE_EVENTS_DTL_12  partition(D20190329_USAGE_EVENTS)
union all
select * from report_user.IT_MIS_USAGE_EVENTS_DTL_12  partition(D20190330_USAGE_EVENTS)
union all
select * from report_user.IT_MIS_USAGE_EVENTS_DTL_12  partition(D20190331_USAGE_EVENTS)
union all
select * from report_user.IT_MIS_USAGE_EVENTS_DTL_12  partition(D20190401_USAGE_EVENTS)
) 
WHERE ORIGIN_REALM in ('mc.com','pcrf.mahindracomviva.com') and SERVICE_IDENTIFIER_ID in('84151', '84271') and CHARGING_CONTEXT in ('SCAP_V.2.0@ericsson.com') 
group by SERVICE_IDENTIFIER_ID,to_date(to_char(UTC_TIMESTAMP,'dd/mm/yyyy'),'dd/mm/yyyy'),SERVED_MSISDN) A

full outer join

(select to_date(substr(DATETIME,9,2)||'/'||substr(DATETIME,6,2)||'/'||substr(DATETIME,1,4),'dd/mm/yyyy') REPORT_DATE,FROMMSISDN  MSISDN, AMOUNT,count(*) TOTAL, '100' CHANEL
from IT_EWP_FINANCIAL_CSV
where to_date(substr(DATETIME,9,2)||'/'||substr(DATETIME,6,2)||'/'||substr(DATETIME,1,4),'dd/mm/yyyy') between to_date('29/03/2019','dd/mm/yyyy') AND to_date('01/04/2019','dd/mm/yyyy')
and TOUSERNAME like '%mtn.sp%' and TRANSACTIONTYPE='DEBIT' and AMOUNT = 5500
group by FROMMSISDN , AMOUNT, to_date(substr(DATETIME,9,2)||'/'||substr(DATETIME,6,2)||'/'||substr(DATETIME,1,4),'dd/mm/yyyy')

UNION ALL

select to_date(substr(DATETIME,9,2)||'/'||substr(DATETIME,6,2)||'/'||substr(DATETIME,1,4),'dd/mm/yyyy') REPORT_DATE, substr(TOUSERNAME,1,12) MSISDN, AMOUNT,count(*) TOTAL,'440' CHANEL
from IT_EWP_FINANCIAL_CSV
where to_date(substr(DATETIME,9,2)||'/'||substr(DATETIME,6,2)||'/'||substr(DATETIME,1,4),'dd/mm/yyyy') between to_date('29/03/2019','dd/mm/yyyy') AND to_date('01/04/2019','dd/mm/yyyy')
and TOUSERNAME like '%databundle%' and TRANSACTIONTYPE='EXTERNAL_PAYMENT' and AMOUNT = 5500
group by substr(TOUSERNAME,1,12), AMOUNT, to_date(substr(DATETIME,9,2)||'/'||substr(DATETIME,6,2)||'/'||substr(DATETIME,1,4),'dd/mm/yyyy')
) B on A.CRS_MSISDN = B.MSISDN and A.CRS_REPORT_DATE = B.REPORT_DATE
where B.MSISDN is not null

truncate table EWP_FINANCIAL_CSV_2020;

insert into EWP_FINANCIAL_CSV_2020
select * from temp;
 
create table EWP_FINANCIAL_CSV_2020 as
select * from EWP_FINANCIAL_CSV_BKP
where substr(DATETIME,1,4)=2020
